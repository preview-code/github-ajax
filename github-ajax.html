<!--
@license
Copyright (c) 2017 Preview-Code. All rights reserved.
This code may only be used under the BSD style license found in LICENSE.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
Wrapper around iron-ajax to enable caching of ETags and proper handling
of params with oAuth tokens.

@demo demo/index.html
-->
<dom-module id="github-ajax">
  <template>
    <!--<iron-ajax
      id="ajax"
      url="[[url]]"
      params="[[params]]"
      method="[[method]]"
      headers="[[headers]]"
      content-type="[[contentType]]"
      body="[[body]]"
      sync="[[sync]]"
      handle-as="[[handleAs]]"
      with-credentials="[[withCredentials]]"
      timeout="[[timeout]]"
      auto="[[auto]]"
      verbose="[[verbose]]"
      loading="{{_loading}}"
      last-error="{{_lastError}}"
      last-request="{{_lastRequest}}"
      last-response="{{_lastResponse}}"
      active-requests="{{_activeRequests}}"
      debounce-duration="{{debounceDuration}}"
      json-prefix="[[jsonPrefix]]"
      on-request="_onRequest"
      on-response="_onResponse"
      on-error="_onError"></iron-ajax>-->
  </template>
  <script>
  (function() {
    var sharedToken;
    var instances = [];

    Polymer({
      is: 'github-ajax',
      properties: {
        /**
         * How many results must be retrieved from GitHub, default 10.
         * @type {Number}
         */
        perPage: {
          type: Number,
          observer: '_onPerPageChange'
        },

        /**
         * The nth page from GitHub, used to travers through pagination.
         * @type {Number}
         */
        page: {
          type: Number,
          observer: '_onPageChange'
        },

        /**
         * OAuth access token for authenticated requests, e.g.: fetching the current user.
         * @type{String}
         */
        accessToken: {
          type: String,
          observer: '_onTokenChange'
        },

        _loading: {
          type: Boolean,
          observer: '_onLoadingChange'
        },

        _lastRequest: {
          type: Boolean,
          observer: '_onLastRequestChange'
        },

        _lastResponse: {
          type: Boolean,
          observer: '_onLastResponseChange'
        },

        _lastError: {
          type: Boolean,
          observer: '_onLastErrorChange'
        },

        _activeRequests: {
          type: Array,
          observer: '_onActiveRequestsChange'
        },


        /**
         * RE-EXPORTED PROPERTIES FROM IRON-AJAX
         */
        url: String,
        params: {
          type: Object,
          value: function() { return {} }
        },
        method: {
          type: String,
          value: 'GET'
        },
        headers: {
          type: Object,
          value: function() { return {} }
        },
        contentType: {
          type: String,
          value: null
        },
        body: {
          type: Object,
          value: null
        },
        sync: {
          type: Boolean,
          value: false
        },
        handleAs: {
          type: String,
          value: 'json'
        },
        withCredentials: {
          type: Boolean,
          value: false
        },
        timeout: {
          type: Number,
          value: 0
        },
        auto: {
          type: Boolean,
          value: false
        },
        verbose: {
          type: Boolean,
          value: false
        },
        lastRequest: {
          type: Object,
          notify: true,
          readOnly: true
        },
        loading: {
          type: Boolean,
          notify: true,
          readOnly: true,
        },
        lastResponse: {
          type: Object,
          notify: true,
          readOnly: true
        },
        lastError: {
          type: Object,
          notify: true,
          readOnly: true
        },
        activeRequests: {
          type: Array,
          notify: true,
          readOnly: true,
        },
        debounceDuration: {
          type: Number,
          value: 0,
          notify: true
        },
        jsonPrefix: {
          type: String,
          value: ''
        },
        bubbles: {
          type: Boolean,
          value: false
        },

        _cacheName: {
          type: String,
          value: 'github-cache'
        }
      },
      
      observers: [
        '_requestOptionsChanged(page, perPage, accessToken)'
        // '_updateIfNoneMatch(refurl, page)'
      ],

      attached: function() {
        if (sharedToken) this.accessToken = sharedToken;
        instances.push(this);
      },

      detached: function() {
        var index = instances.indexOf(this);
        instances.splice(index, 1);
      },

      _requestOptionsChanged: function() {
        this.$.ajax._requestOptionsChanged();
      },

      _onPerPageChange: function(itemCount) {
        if (this.params) this.params['per_page'] = itemCount;
      },

      _onPageChange: function(newPage) {
        if (this.params) this.params['page'] = newPage
      },

      _onTokenChange: function(newToken) {
        if (newToken !== sharedToken) {
          sharedToken = newToken;
          instances.forEach(function(instance) {
            instance.accessToken = sharedToken;
          });
        }
        if (this.params) this.params['access_token'] = newToken;
      },

      _onLoadingChange: function(loading) {
        this._setLoading(loading);
        
        // this.fire('loading-changed', e.detail);
      },

      _onActiveRequestsChange: function(activeRequests) {
        this._setActiveRequests(activeRequests);
      },

      _onLastRequestChange: function(request) {
        this._setLastRequest(request);
      },
      
      _onLastResponseChange: function(response) {
        this._setLastResponse(response);
      },

      _onLastErrorChange: function(error) {
        this._setLastError(error);
      },

      // _updateIfNoneMatch: function(refurl, page) {
      //   var etag = shared.headerCache[refurl + 'page' + page];
      //   if (etag) {
      //     this._setHeader('If-None-Match', etag);
      //   }
      // },

      _onRequest: function(e) {
        e.stopPropagation();
        this.fire('request', {
          request: e.detail.request,
          options: e.detail.requestOptions
        }, {bubbles: this.bubbles});

        this.fire('iron-ajax-request', {
          request: e.detail.request,
          options: e.detail.requestOptions
        }, {bubbles: this.bubbles});
      },

      _onResponse: function(e) {
        e.stopPropagation();

        caches.open(this._cacheName).then(function(cache) {
          var xhr = e.detail.xhr;
          
          var r = new Response(xhr.response, {
            type: 'basic',
            url: xhr.url,            
            headers: xhr.responseHeaders,
            status: xhr.status,
            statusText: xhr.statusText,
          });
          debugger;
          
          return cache.put(e.detail, r);
        }).then(function() {
          this.fire('response', e.detail.response, {bubbles: this.bubbles});
          this.fire('iron-ajax-response', e.detail.response, {bubbles: this.bubbles});
        }.bind(this));
      },

      _onError: function(e) {
        e.stopPropagation();
        this.fire('iron-ajax-error', {
          request: e.detail.request,
          error: e.detail.error
        }, {bubbles: this.bubbles});
        this.fire('error', {
          request: e.detail.request,
          error: e.detail.error
        }, {bubbles: this.bubbles});

        // shared.headerCache[this.refurl] = e.detail.request.xhr.getResponseHeader('ETag');
        // Cache responses to save the rate limit of the GitHub api
        // if (e.detail.request.status === 304) {
        //   this._retrievePreviousRequestFromCache();
        // } else {
        // }
      },

      // _retrievePreviousRequestFromCache: function() {
      //   this._setLastResponse(shared.responseCache[this.refurl + 'page' + this.page]);
      //   // Inject our last response
      //   this.lastRequest._setResponse(this.lastResponse);
      //   this.fire('response', Object.create(this.lastRequest), {
      //     bubbles: this.bubbles
      //   });
      // }

      /**
       * RE-EXPORTED FROM IRON-AJAX
       */
      get queryString () {
        return this.$.ajax.queryString;
      },
      get requestUrl() {
        return this.$.ajax.requestUrl;
      },
      get requestHeaders() {
        return this.$.ajax.requestHeaders
      },

      toRequestOptions: function() {
        return this.$.ajax.toRequestOptions();
      },
      generateRequest: function() {
        return this.$.ajax.generateRequest();
      }
    });
  })();
  </script>
</dom-module>
